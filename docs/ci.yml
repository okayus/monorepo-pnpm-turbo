name: ğŸ” Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šåŒã˜PRã§è¤‡æ•°ã®CIå®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # å…±é€šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æœ€åˆã«ãƒ“ãƒ«ãƒ‰
  shared-build:
    name: ğŸ”§ Build Shared Package
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build shared package
        run: pnpm --filter=shared build

      - name: ğŸ“¤ Upload shared build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shared-dist
          path: packages/shared/dist
          retention-days: 1

  # Lintãƒ»TypeCheckãƒ»ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆsharedãƒ“ãƒ«ãƒ‰å¾Œï¼‰
  quality-check:
    name: ğŸ§¹ Code Quality Check
    runs-on: ubuntu-latest
    needs: [shared-build]
    
    strategy:
      fail-fast: false
      matrix:
        package: [backend, shared, frontend]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ Download shared build artifacts
        if: matrix.package != 'shared'
        uses: actions/download-artifact@v4
        with:
          name: shared-dist
          path: packages/shared/dist

      - name: ğŸ—ï¸ Build shared package (if shared)
        if: matrix.package == 'shared'
        run: pnpm --filter=shared build

      - name: ğŸ§¹ Run ESLint
        run: pnpm --filter=${{ matrix.package }} lint
        continue-on-error: false

      - name: ğŸ” Run TypeScript Check
        run: pnpm --filter=${{ matrix.package }} typecheck
        continue-on-error: false

      - name: ğŸ§ª Run Tests
        run: pnpm --filter=${{ matrix.package }} test
        continue-on-error: false

      # ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆï¼ˆå°†æ¥å®Ÿè£…ï¼‰
      # - name: ğŸ“Š Generate Coverage Report
      #   run: pnpm --filter=${{ matrix.package }} test:coverage
      #   continue-on-error: true

  # å…¨ä½“çµ±åˆãƒã‚§ãƒƒã‚¯
  integration-check:
    name: ğŸ”— Integration Check
    runs-on: ubuntu-latest
    needs: [shared-build, quality-check]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¥ Download shared build artifacts
        uses: actions/download-artifact@v4
        with:
          name: shared-dist
          path: packages/shared/dist

      # Cloudflare Workersé–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ†ã‚¹ãƒˆ
      - name: ğŸ§ª Test Wrangler Dev Startup
        run: |
          cd packages/backend
          timeout 30s pnpm dev || exit_code=$?
          if [ ${exit_code} -eq 124 ]; then
            echo "âœ… Wrangler dev started successfully (timed out as expected)"
            exit 0
          elif [ ${exit_code} -eq 0 ]; then
            echo "âœ… Wrangler dev started successfully"
            exit 0
          else
            echo "âŒ Wrangler dev failed to start"
            exit 1
          fi

      # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ“ãƒ«ãƒ‰ç¢ºèª
      - name: ğŸ—ï¸ Build Check
        run: |
          echo "âœ… All quality checks passed!"
          echo "ğŸ“¦ Packages: backend, shared, frontend"
          echo "ğŸ¯ Ready for deployment pipeline!"

  # CIæˆåŠŸé€šçŸ¥
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [quality-check, integration-check]
    if: success()
    
    steps:
      - name: ğŸ‰ All Checks Passed
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo "âœ… Code quality checks passed"
          echo "âœ… TypeScript compilation successful" 
          echo "âœ… All tests passed"
          echo "âœ… Integration checks completed"
          echo ""
          echo "Ready for merge! ğŸš€"