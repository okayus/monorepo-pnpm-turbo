name: ğŸ” Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼šåŒã˜PRã§è¤‡æ•°ã®CIå®Ÿè¡Œã‚’é˜²ã
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆBackend & Frontendï¼‰
  quality-check:
    name: ğŸ§¹ Quality Check (${{ matrix.package }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [backend, frontend]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ’… Run Prettier Check
        run: pnpm --filter=${{ matrix.package }} format:check
        continue-on-error: false

      - name: ğŸ§¹ Run ESLint
        run: pnpm --filter=${{ matrix.package }} lint
        continue-on-error: false

      - name: ğŸ”¨ Generate Wrangler Types
        run: pnpm --filter=backend types:generate
        continue-on-error: false

      - name: ğŸ—ï¸ Build Backend (for typecheck)
        run: pnpm --filter=backend exec tsc --build --force
        continue-on-error: false

      - name: ğŸ” Run TypeScript Check
        run: pnpm --filter=${{ matrix.package }} typecheck
        continue-on-error: false

      - name: ğŸ§ª Run Tests
        run: pnpm --filter=${{ matrix.package }} test
        continue-on-error: false

  # Wranglerçµ±åˆãƒã‚§ãƒƒã‚¯
  integration-check:
    name: ğŸ”— Integration Check
    runs-on: ubuntu-latest
    needs: [quality-check]

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¥ Install dependencies
        run: pnpm install --frozen-lockfile

      # Cloudflare Workersé–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ãƒ†ã‚¹ãƒˆ
      - name: ğŸ§ª Test Wrangler Dev Startup
        run: |
          cd packages/backend
          timeout 30s pnpm dev || exit_code=$?
          if [ ${exit_code} -eq 124 ]; then
            echo "âœ… Wrangler dev started successfully (timed out as expected)"
            exit 0
          elif [ ${exit_code} -eq 0 ]; then
            echo "âœ… Wrangler dev started successfully"
            exit 0
          else
            echo "âŒ Wrangler dev failed to start"
            exit 1
          fi

      # Frontend Build Test
      - name: ğŸ—ï¸ Frontend Build Test
        run: |
          cd packages/frontend
          pnpm build
          echo "âœ… Frontend build successful!"

      - name: ğŸ—ï¸ Build Check
        run: |
          echo "âœ… All quality checks passed!"
          echo "ğŸ“¦ Packages: backend, frontend"
          echo "ğŸ¯ Ready for deployment pipeline!"

  # CIæˆåŠŸé€šçŸ¥
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    needs: [quality-check, integration-check]
    if: success()

    steps:
      - name: ğŸ‰ All Checks Passed
        run: |
          echo "ğŸ‰ CI Pipeline completed successfully!"
          echo "âœ… Code quality checks passed"
          echo "âœ… TypeScript compilation successful"
          echo "âœ… All tests passed"
          echo "âœ… Integration checks completed"
          echo ""
          echo "Ready for merge! ğŸš€"
